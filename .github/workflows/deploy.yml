name: Deploy Backend to Swarm

on:
  pull_request:
    branches:
      - main  # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ CI/CD Ð¿Ñ€Ð¸ PR Ð² release-Ð²ÐµÑ‚ÐºÑƒ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð´ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ñ‚ÐµÐ³Ð° Ñ Ð´Ð°Ñ‚Ð¾Ð¹ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼
        run: echo "IMAGE_TAG=$(date +'%d.%m.%Y_%H.%M.%S')" >> $GITHUB_ENV

      - name: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ IMAGE_URL
        run: echo "IMAGE_URL=${{ secrets.REGISTRY_URL }}/${{ secrets.APP_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV

      - name: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ IMAGE_URL_LATEST
        run: echo "IMAGE_URL_LATEST=${{ secrets.REGISTRY_URL }}/${{ secrets.APP_NAME }}:latest" >> $GITHUB_ENV

      - name: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ IMAGE_MIGRATION_URL
        run: echo "IMAGE_MIGRATION_URL=${{ secrets.REGISTRY_URL }}/migration_${{ secrets.APP_NAME }}:latest" >> $GITHUB_ENV

      - name: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ SERVICE_STACK
        run: echo "SERVICE_STACK=${{ secrets.APP_NAME }}_stack_" >> $GITHUB_ENV

      - name: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ SERVICE_NAME
        run: echo "SERVICE_NAME=${{ env.SERVICE_STACK }}_backend" >> $GITHUB_ENV

      - name: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ SERVICE_MIGRATION_NAME
        run: echo "SERVICE_MIGRATION_NAME=migration_${{ secrets.APP_NAME }}" >> $GITHUB_ENV

#      - name: Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð¿ÑƒÑˆÐ¸Ð¼ Docker-Ð¾Ð±Ñ€Ð°Ð· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
#        run: |
#                docker buildx build --platform linux/amd64 \
#                  --build-arg DATABASE_URL=${{ secrets.DATABASE_URL }} \
#                  -t ${{ env.IMAGE_URL }} \
#                  -t ${{ env.IMAGE_URL_LATEST }} \
#                  -f Dockerfile . --push
#
#      - name: Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð¿ÑƒÑˆÐ¸Ð¼ Docker-Ð¾Ð±Ñ€Ð°Ð· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
#        run: |
#          docker buildx build --platform linux/amd64 \
#            --build-arg DATABASE_URL=${{ secrets.DATABASE_URL }} \
#            -t ${{ env.IMAGE_MIGRATION_URL }} \
#            -f Dockerfile-migrator . --push

      # ðŸ”¹ 2. Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² Docker Registry
#      - name: Login to Docker Registry
#        run: echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login registry.good-buket-tech.ru -u "${{ secrets.DOCKER_REGISTRY_USER }}" --password-stdin

#      - name: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð¿Ð¾ SSH Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð² Swarm (ÐµÑÐ»Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð½ÑƒÐ¶Ð½Ñ‹)
#        uses: appleboy/ssh-action@v0.1.10
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          script: |
#            docker stack deploy -c /apps/gb-back-migrate.yml migration_${{ secrets.APP_NAME }}_stack
#            sleep 10  # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
#            docker service logs migration_${{ secrets.APP_NAME }}_stack_migrator
#            docker stack rm migration_${{ secrets.APP_NAME }}_stack  # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ

      - name: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð¿Ð¾ SSH Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑÐµÑ€Ð²Ð¸Ñ
        id: check-service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          allenvs: true
          script: |
            if docker service inspect ${{ env.SERVICE_NAME }} > /dev/null 2>&1; then 
              echo "âœ… Service exists, updating..."; 
              echo "::set-output name=SERVICE_IS_EXISTS::true";
              echo "SERVICE_IS_EXISTS2=true";
              echo "SERVICE_IS_EXISTS3=true" >> $GITHUB_OUTPUT
            else
              echo "ðŸš€ Service does not exist, creating...";
              echo "::set-output name=SERVICE_IS_EXISTS::false";
              echo "SERVICE_IS_EXISTS2=true";
              echo "SERVICE_IS_EXISTS3=true" >> $GITHUB_OUTPUT
            fi
            

      - name: ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð¿Ð¾ SSH Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ Ð² Swarm
        if: steps.check-service.outputs.SERVICE_IS_EXISTS3 == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          allenvs: true
#          script_stop: true
          script: |
            echo "SERVICE_IS_EXISTS3=${{ env.SERVICE_IS_EXISTS3 }}"
            echo ${{ steps.check-service.outputs.SERVICE_IS_EXISTS3 }}
#            echo "SERVICE_IS_EXISTS=${{ env.SERVICE_IS_EXISTS }}"
#            echo "SERVICE_IS_EXISTS2=${{ env.SERVICE_IS_EXISTS2 }}"

#            if docker service inspect ${{ env.SERVICE_NAME }} > /dev/null 2>&1; then
#              echo "âœ… Service exists, updating...";
##              docker service update --image ${{ env.IMAGE_URL }} ${{ env.SERVICE_NAME }}
#            else
#              echo "ðŸš€ Service does not exist, creating...";
##              docker stack deploy -c /apps/gb-back.yml ${{ env.SERVICE_STACK }}
#            fi
#
#            docker service ps ${{ env.SERVICE_NAME }}

