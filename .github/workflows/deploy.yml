name: Deploy Backend to Swarm

on:
  pull_request:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞—Ç—å CI/CD –ø—Ä–∏ PR –≤ release-–≤–µ—Ç–∫—É

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –ì–æ—Ç–æ–≤–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Ç–µ–≥–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
        run: echo "IMAGE_TAG=$(date +'%d.%m.%Y_%H.%M.%S')" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é IMAGE_URL
        run: echo "IMAGE_URL=${{ secrets.REGISTRY_URL }}/${{ secrets.APP_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é IMAGE_URL_LATEST
        run: echo "IMAGE_URL_LATEST=${{ secrets.REGISTRY_URL }}/${{ secrets.APP_NAME }}:latest" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é IMAGE_MIGRATION_URL
        run: echo "IMAGE_MIGRATION_URL=${{ secrets.REGISTRY_URL }}/migration_${{ secrets.APP_NAME }}:latest" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SERVICE_STACK
        run: echo "SERVICE_STACK=${{ secrets.APP_NAME }}_stack_" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SERVICE_NAME
        run: echo "SERVICE_NAME=${{ env.SERVICE_STACK }}_app" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SERVICE_MIGRATION_NAME
        run: echo "SERVICE_MIGRATION_NAME=migration_${{ secrets.APP_NAME }}" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SERVICE_APP_COMPOSE_PATH
        run: echo "SERVICE_APP_COMPOSE_PATH=/apps/${{ secrets.APP_NAME }}_composes" >> $GITHUB_ENV

      - name: –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker-–æ–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        run: |
                docker buildx build --platform linux/amd64 \
                  --build-arg DATABASE_URL=${{ secrets.DATABASE_URL }} \
                  -t ${{ env.IMAGE_URL }} \
                  -t ${{ env.IMAGE_URL_LATEST }} \
                  -f Dockerfile . --push

#      - name: –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker-–æ–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏
#        run: |
#          docker buildx build --platform linux/amd64 \
#            --build-arg DATABASE_URL=${{ secrets.DATABASE_URL }} \
#            -t ${{ env.IMAGE_MIGRATION_URL }} \
#            -f Dockerfile-migrator . --push

      # üîπ 2. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Registry
#      - name: Login to Docker Registry
#        run: echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login registry.good-buket-tech.ru -u "${{ secrets.DOCKER_REGISTRY_USER }}" --password-stdin

#      - name: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Swarm (–µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã)
#        uses: appleboy/ssh-action@v0.1.10
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          script: |
#            docker stack deploy -c /apps/gb-back-migrate.yml migration_${{ secrets.APP_NAME }}_stack
#            sleep 10  # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
#            docker service logs migration_${{ secrets.APP_NAME }}_stack_migrator
#            docker stack rm migration_${{ secrets.APP_NAME }}_stack  # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

      - name: –ö–æ–ø–∏—Ä—É–µ–º compose-—Ñ–∞–π–ª—ã –Ω–∞ VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/*"
          target: "${{ env.SERVICE_APP_COMPOSE_PATH }}"
          strip_components: 1

      - name: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –≤ Swarm
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            if docker service inspect ${{ env.SERVICE_NAME }} > /dev/null 2>&1; then
              echo "‚úÖ Service exists, updating...";
              docker service update --image ${{ env.IMAGE_URL }} ${{ env.SERVICE_NAME }}
            else
              echo "üöÄ Service does not exist, creating...";
              docker stack deploy -c ${{ env.SERVICE_APP_COMPOSE_PATH }}/app-compose.yml ${{ env.SERVICE_STACK }}
            fi

            docker service ps ${{ env.SERVICE_NAME }}


      - name: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã compose
        id: check-service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          allenvs: true
          script: |
            rm -rf ${{ env.SERVICE_APP_COMPOSE_PATH }}
