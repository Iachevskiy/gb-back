name: Deploy Backend to Swarm

on:
  pull_request:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞—Ç—å CI/CD –ø—Ä–∏ PR –≤ release-–≤–µ—Ç–∫—É

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:


      # üîπ 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üîπ –ù–∞—á–∞–ª–æ CI/CD
      - run: echo "‚û°Ô∏è CI/CD –∑–∞–ø—É—â–µ–Ω –¥–ª—è –≤–µ—Ç–∫–∏ ${{ github.ref }}"

      # üîπ 2. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Registry
#      - name: Login to Docker Registry
#        run: echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login registry.good-buket-tech.ru -u "${{ secrets.DOCKER_REGISTRY_USER }}" --password-stdin

      # üîπ 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
#      - name: Check for migration changes
#        id: check_migrations
#        run: |
#          if git diff --name-only origin/main..HEAD | grep -E 'migrations|drizzle.config.ts'; then
#            echo "MIGRATIONS_NEEDED=true" >> $GITHUB_ENV
#          else
#            echo "MIGRATIONS_NEEDED=false" >> $GITHUB_ENV
#          fi

      # üîπ 4. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker-–æ–±—Ä–∞–∑ –º–∏–≥—Ä–∞—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã)
#      - name: Build and Push Migrator Image
#        if: env.MIGRATIONS_NEEDED == 'true'
#        run: |
#          docker buildx build --platform linux/amd64 \
#            -t registry.good-buket-tech.ru/migrator:${{ github.run_number }} \
#            -t registry.good-buket-tech.ru/migrator:latest \
#            -f Dockerfile-migrator . --push

      # üîπ 5. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Swarm (–µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã)
#      - name: Run Database Migrations
#        if: env.MIGRATIONS_NEEDED == 'true'
#        uses: appleboy/ssh-action@v0.1.10
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          script: |
#            docker stack deploy -c docker-compose.migrations.yml migrations_stack
#            sleep 10  # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
#            docker service logs migrations_stack_migrator
#            docker stack rm migrations_stack  # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

      # üîπ 6. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker-–æ–±—Ä–∞–∑ –±—ç–∫–µ–Ω–¥–∞
#      - name: Build and Push Backend Image
#        run: |
#          docker buildx build --platform linux/amd64 \
#            -t registry.good-buket-tech.ru/backend:${{ github.run_number }} \
#            -t registry.good-buket-tech.ru/backend:latest \
#            -f Dockerfile . --push

      # üîπ 7. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –≤ Swarm
#      - name: Deploy Backend to Swarm
#        uses: appleboy/ssh-action@v0.1.10
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          script: |
#            docker service update --image registry.good-buket-tech.ru/backend:${{ github.run_number }} backend_backend
#            docker service ps backend_backend
