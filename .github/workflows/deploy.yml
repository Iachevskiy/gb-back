name: Deploy Backend to Swarm

on:
  pull_request:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞—Ç—å CI/CD –ø—Ä–∏ PR –≤ release-–≤–µ—Ç–∫—É

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # üîπ 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag with formatted date-time
        run: echo "IMAGE_TAG=$(date +'%d.%m.%Y_%H.%M.%S')" >> $GITHUB_ENV

      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL
        run: echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV

      - name: üîπ –ù–∞—á–∞–ª–æ CI/CD
        run: echo "‚û°Ô∏è CI/CD –∑–∞–ø—É—â–µ–Ω –¥–ª—è –≤–µ—Ç–∫–∏ ${{ github.ref }} ${{ env.IMAGE_TAG }} ${{ env.DATABASE_URL }}"

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è DATABASE_URL
        run: |
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: —Å–µ–∫—Ä–µ—Ç DATABASE_URL –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω!"
            exit 1
          else
            echo "‚úÖ DATABASE_URL –∑–∞–≥—Ä—É–∂–µ–Ω! ${{ secrets.DATABASE_URL }}"
            exit 1
          fi

      # üîπ 4. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker-–æ–±—Ä–∞–∑ –±—ç–∫–∞
      - name: Build and Push Migrator Image
        run: |
                docker buildx build --platform linux/amd64 \
                  --build-arg DATABASE_URL=${{ secrets.DATABASE_URL }} \
                  -t registry.good-buket-tech.ru/back2:${{ env.IMAGE_TAG }} \
                  -f Dockerfile . --push

      # üîπ 2. –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Registry
#      - name: Login to Docker Registry
#        run: echo "${{ secrets.DOCKER_REGISTRY_PASSWORD }}" | docker login registry.good-buket-tech.ru -u "${{ secrets.DOCKER_REGISTRY_USER }}" --password-stdin

      # üîπ 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
#      - name: Check for migration changes
#        id: check_migrations
#        run: |
#          if git diff --name-only origin/main..HEAD | grep -E 'migrations|drizzle.config.ts'; then
#            echo "MIGRATIONS_NEEDED=true" >> $GITHUB_ENV
#          else
#            echo "MIGRATIONS_NEEDED=false" >> $GITHUB_ENV
#          fi



      # üîπ 5. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Swarm (–µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã)
      - name: Run Database Migrations
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
            docker service ls
            docker service update --image registry.good-buket-tech.ru/back2:${{ env.IMAGE_TAG }} back2_backend
            sleep 10  # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
            docker service ps back2_backend
            docker service logs back2_backend
#            docker stack deploy -c docker-compose.migrations.yml migrations_stack
#            sleep 10  # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
#            docker service logs migrations_stack_migrator
#            docker stack rm migrations_stack  # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#      docker service update --image registry.good-buket-tech.ru/back2:18.02.2025_09.23.03 back2_backend

      # üîπ 6. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker-–æ–±—Ä–∞–∑ –±—ç–∫–µ–Ω–¥–∞
#      - name: Build and Push Backend Image
#        run: |
#          docker buildx build --platform linux/amd64 \
#            -t registry.good-buket-tech.ru/backend:${{ github.run_number }} \
#            -t registry.good-buket-tech.ru/backend:latest \
#            -f Dockerfile . --push

      # üîπ 7. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å –≤ Swarm
#      - name: Deploy Backend to Swarm
#        uses: appleboy/ssh-action@v0.1.10
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          script: |
#            docker service update --image registry.good-buket-tech.ru/backend:${{ github.run_number }} back2_backend
#            docker service ps backend_backend
